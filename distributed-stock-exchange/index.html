<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Pro Trading Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e2e; color: #cdd6f4; margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #181825; padding: 15px; border-radius: 10px; }
        .grid-container { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 20px; height: 85vh; }

        .panel { background: #313244; padding: 15px; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        h2, h3 { margin-top: 0; color: #89b4fa; font-size: 1.1rem; border-bottom: 1px solid #45475a; padding-bottom: 10px; }


        input, select, button { width: 100%; padding: 8px; margin-top: 5px; background: #45475a; border: 1px solid #585b70; color: white; border-radius: 4px; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; margin-top: 15px; transition: 0.2s; }
        .btn-buy { background-color: #a6e3a1; color: #1e1e2e; }
        .btn-sell { background-color: #f38ba8; color: #1e1e2e; }
        .btn-modify { background-color: #f9e2af; color: #1e1e2e; margin-top: 0; width: auto; padding: 4px 10px; }


        .order-book-container { display: flex; gap: 10px; height: 100%; }
        .book-side { flex: 1; display: flex; flex-direction: column; }
        .book-row { display: flex; justify-content: space-between; padding: 4px; border-bottom: 1px solid #45475a; font-size: 0.9em; }
        .ask-row { color: #f38ba8; }
        .bid-row { color: #a6e3a1; }


        .my-order-item { background: #181825; padding: 10px; margin-bottom: 5px; border-radius: 5px; border-left: 4px solid #89b4fa; }
        .modify-group { display: flex; gap: 5px; margin-top: 5px; }


        #tradeLog { overflow-y: auto; flex-grow: 1; font-family: monospace; font-size: 0.85rem; }
        .log-entry { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #45475a; }
        .log-buyer { color: #a6e3a1; }
        .log-seller { color: #f38ba8; }

        .ai-section { margin-top: 20px; background: #11111b; padding: 10px; border-radius: 5px; border: 1px solid #cba6f7; }
    </style>
</head>
<body>

<div class="header">
    <div>
        <span style="font-size: 1.5em;">üöÄ Bursa DistribuitƒÉ</span>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
        <label>üë§ Trader:</label>
        <input type="text" id="traderId" value="Trader-1" style="width: 150px; margin:0;">
        <select id="activeSymbol" onchange="refreshData()" style="width: 100px; margin:0;">
            <option value="AAPL">AAPL</option>
            <option value="MSFT">MSFT</option>
            <option value="GOOGL">GOOGL</option>
        </select>
    </div>
</div>

<div class="grid-container">

    <div class="panel">
        <h2>üìù PlaseazƒÉ Ordin</h2>
        <label>Tip:</label>
        <select id="type">
            <option value="BUY">üü¢ CUMPƒÇRƒÇ (BID)</option>
            <option value="SELL">üî¥ VINDE (ASK)</option>
        </select>
        <label>Pre»õ ($):</label>
        <input type="number" id="price" value="150">
        <label>Cantitate:</label>
        <input type="number" id="quantity" value="10">

        <button onclick="submitOrder()" id="actionBtn" class="btn-buy">TRIMITE ORDIN</button>
        <div id="statusMsg" style="margin-top: 10px; height: 20px;"></div>

        <div class="ai-section">
            <h3>ü§ñ AI Analist</h3>
            <button onclick="askAi()" style="background:#cba6f7; color:#1e1e2e;">AnalizeazƒÉ Pia»õa</button>
            <div id="aiResult" style="margin-top:5px; font-size: 0.8em; white-space: pre-wrap;">...</div>
        </div>

        <div class="ai-section" style="border-color:#f9e2af;">
            <h3>üö® Alarme Pre»õ</h3>
            <div id="alertsList" style="font-size: 0.85em;">Nicio alertƒÉ activƒÉ.</div>
        </div>
    </div>

    <div class="panel">
        <h2>üìä Order Book: <span id="symbolDisplay">AAPL</span></h2>
        <div class="order-book-container">
            <div class="book-side">
                <h3 style="color:#a6e3a1; text-align: center;">BIDS (CumpƒÉrƒÉ)</h3>
                <div id="bidsList" style="overflow-y: auto;"></div>
            </div>
            <div class="book-side">
                <h3 style="color:#f38ba8; text-align: center;">ASKS (Vinde)</h3>
                <div id="asksList" style="overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>‚öôÔ∏è Ordinele Mele Active</h2>
        <div id="myOrdersList" style="height: 40%; overflow-y: auto; margin-bottom: 20px;"></div>

        <h2>üìú Istoric Tranzac»õii</h2>
        <div id="tradeLog"></div>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:8080/api';
    const AI_URL = 'http://localhost:8081';
    const AI_EXCHANGE_URL = (window.location.port === '8082')
        ? 'http://exchange-server:8080/api/trades'
        : `${API_URL}/trades`;
    const seenAlerts = new Set();


    document.getElementById('type').addEventListener('change', (e) => {
        const btn = document.getElementById('actionBtn');
        if(e.target.value === 'BUY') {
            btn.className = 'btn-buy';
            btn.innerText = 'TRIMITE BID (CUMPƒÇRƒÇ)';
        } else {
            btn.className = 'btn-sell';
            btn.innerText = 'TRIMITE ASK (VINDE)';
        }
    });

    async function submitOrder() {
        const order = {
            stockSymbol: document.getElementById('activeSymbol').value,
            orderType: document.getElementById('type').value,
            price: parseFloat(document.getElementById('price').value),
            quantity: parseInt(document.getElementById('quantity').value),
            traderId: document.getElementById('traderId').value
        };

        await fetch(`${API_URL}/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(order)
        });
        refreshData();
    }

    async function modifyOrder(orderId) {
        const newPrice = prompt("Introdu noul pre»õ pentru ordin:");
        if(newPrice) {
            await fetch(`${API_URL}/orders/${orderId}/modify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newPrice: parseFloat(newPrice) })
            });
            refreshData();
        }
    }

    async function cancelOrder(orderId) {
        if(confirm("Sigur vrei sƒÉ anulezi?")) {
            await fetch(`${API_URL}/orders/${orderId}/cancel`, { method: 'POST' });
            refreshData();
        }
    }

    async function askAi() {
        document.getElementById('aiResult').innerText = "‚è≥ G√¢ndesc...";
        try {
            const res = await fetch(`${AI_URL}/analyze?exchangeUrl=${encodeURIComponent(AI_EXCHANGE_URL)}`);
            const text = await res.text();
            document.getElementById('aiResult').innerText = text;
        } catch(e) {
            document.getElementById('aiResult').innerText = "AI Service indisponibil.";
        }
    }

    async function refreshData() {
        const symbol = document.getElementById('activeSymbol').value;
        const currentUser = document.getElementById('traderId').value;
        document.getElementById('symbolDisplay').innerText = symbol;


        try {
            const res = await fetch(`${API_URL}/orderbook/data/${symbol}`);
            if(res.ok) {
                const data = await res.json();
                renderOrderBook(data.bids, data.asks);
                renderMyOrders(data.bids, data.asks, currentUser);
            }
        } catch(e) { console.log("Backend need update for orderbook data"); }


        const tradesRes = await fetch(`${API_URL}/trades`);
        const trades = await tradesRes.json();
        renderTrades(trades);

        await refreshAlerts(currentUser);
    }

    function renderOrderBook(bids, asks) {

        bids.sort((a,b) => b.price - a.price);
        asks.sort((a,b) => a.price - b.price);

        const bidsContainer = document.getElementById('bidsList');
        bidsContainer.innerHTML = bids.map(o => `
                <div class="book-row bid-row">
                    <span>${o.quantity} buc</span>
                    <span>@ $${o.price.toFixed(2)}</span>
                    <span style="font-size:0.8em; opacity:0.7;">(${o.traderId})</span>
                </div>
            `).join('');

        const asksContainer = document.getElementById('asksList');
        asksContainer.innerHTML = asks.map(o => `
                <div class="book-row ask-row">
                    <span>${o.quantity} buc</span>
                    <span>@ $${o.price.toFixed(2)}</span>
                    <span style="font-size:0.8em; opacity:0.7;">(${o.traderId})</span>
                </div>
            `).join('');
    }

    function renderMyOrders(bids, asks, user) {
        const myOrders = [...bids, ...asks].filter(o => o.traderId === user);
        const container = document.getElementById('myOrdersList');

        if(myOrders.length === 0) {
            container.innerHTML = '<div style="color:gray; text-align:center;">Niciun ordin activ</div>';
            return;
        }

        container.innerHTML = myOrders.map(o => `
                <div class="my-order-item">
                    <div><b>${o.orderType}</b> ${o.stockSymbol} x ${o.quantity} @ $${o.price}</div>
                    <div class="modify-group">
                        <button class="btn-modify" onclick="modifyOrder('${o.orderId}')">ModificƒÉ Pre»õ</button>
                        <button class="btn-modify" style="background:#f38ba8;" onclick="cancelOrder('${o.orderId}')">X</button>
                    </div>
                </div>
            `).join('');
    }

    function renderTrades(trades) {
        const container = document.getElementById('tradeLog');

        container.innerHTML = trades.slice().reverse().map(t => `
                <div class="log-entry">
                    Match! <span class="log-buyer">${t.buyerId} (Bid)</span> a cumpƒÉrat de la
                    <span class="log-seller">${t.sellerId} (Ask)</span> <br>
                    <b>${t.stockSymbol}</b>: ${t.quantity} buc la $${t.price}
                </div>
            `).join('');
    }

    async function refreshAlerts(currentUser) {
        try {
            const res = await fetch(`${API_URL}/alerts?traderId=${encodeURIComponent(currentUser)}`);
            if (!res.ok) return;
            const alerts = await res.json();
            renderAlerts(alerts);
            alerts.forEach(a => {
                if (!seenAlerts.has(a.id)) {
                    seenAlerts.add(a.id);
                    const wantsBuy = confirm(`AlertƒÉ: ${a.stockSymbol} la $${a.price.toFixed(2)} (cantitate ${a.quantity}). Cumperi acum?`);
                    if (wantsBuy) {
                        claimAlert(a.id, currentUser);
                    }
                }
            });
        } catch (e) {
            console.log("Alerts unavailable.");
        }
    }

    async function claimAlert(alertId, buyerId) {
        const res = await fetch(`${API_URL}/alerts/${alertId}/claim`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ buyerId })
        });
        if (!res.ok) {
            alert("Alerta a fost deja revendicatƒÉ de altcineva.");
        }
        refreshData();
    }

    function renderAlerts(alerts) {
        const container = document.getElementById('alertsList');
        if (!alerts.length) {
            container.innerHTML = 'Nicio alertƒÉ activƒÉ.';
            return;
        }
        container.innerHTML = alerts.map(a => `
                <div class="my-order-item" style="border-left-color:#f9e2af;">
                    <div><b>${a.stockSymbol}</b> la $${a.price.toFixed(2)} (cantitate ${a.quantity})</div>
                    <div class="modify-group">
                        <button class="btn-modify" onclick="claimAlert('${a.id}', document.getElementById('traderId').value)">CumpƒÉrƒÉ</button>
                    </div>
                </div>
            `).join('');
    }

    setInterval(refreshData, 1000);
    refreshData();
</script>
</body>
</html>